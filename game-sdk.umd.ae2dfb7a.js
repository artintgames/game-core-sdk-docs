(function(o,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(o=typeof globalThis<"u"?globalThis:o||self,f(o.coreSDK={}))})(this,(function(o){"use strict";var f=typeof document<"u"?document.currentScript:null;const O={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};function k(s){if(typeof process<"u"&&process.env){const e=process.env[s];if(e)return e}if(typeof{url:typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:f&&f.tagName.toUpperCase()==="SCRIPT"&&f.src||new URL("game-sdk.umd.js",document.baseURI).href}<"u"&&O){const e=O[s];if(e)return e}if(typeof window<"u"&&window.__ENV__){const e=window.__ENV__[s];if(e)return e}}const ce=k("REACT_APP_BACKEND_URL_ADMIN_PANEL")||"https://configs.artintgames.com",ue=k("REACT_APP_BACKEND_URL_AUTH")||" https://auth.artintgames.com",p={baseUrl:ce,authUrl:ue};function L(s){p.baseUrl=s}function U(s){p.authUrl=s}const K="coreSDK_profiles_v1",he=100,N=300*1e3,le=600*1e3;class de{constructor(e){this.items=new Map,this.maxItems=e?.maxItems??he,this.loadFromStorage()}get(e){const t=this.items.get(e);if(!t)return null;const r=Date.now();return r-t.cachedAt>t.ttl?(this.items.delete(e),this.saveToStorageSafe(),null):(t.lastAccessed=r,t.profile)}set(e,t){const r=Date.now(),i={profile:e,cachedAt:r,lastAccessed:r,ttl:t};this.items.set(e.gid,i),this.evictIfNeeded(),this.saveToStorageSafe()}invalidate(e){this.items.delete(e)&&this.saveToStorageSafe()}invalidateAll(){this.items.clear(),this.saveToStorageSafe()}evictIfNeeded(){if(this.items.size<=this.maxItems)return;const e=Array.from(this.items.entries());e.sort((r,i)=>r[1].lastAccessed-i[1].lastAccessed);const t=e.length-this.maxItems;for(let r=0;r<t;r++){const[i]=e[r];this.items.delete(i)}}loadFromStorage(){if(!(typeof localStorage>"u"))try{const e=localStorage.getItem(K);if(!e)return;const t=JSON.parse(e);if(t.version!==1||!t.items||typeof t.items!="object")return;const r=Date.now();for(const[i,n]of Object.entries(t.items))!n||!n.profile||typeof n.cachedAt!="number"||typeof n.ttl!="number"||r-n.cachedAt>n.ttl||this.items.set(i,n);this.evictIfNeeded()}catch(e){console.error("[ProfileCache] loadFromStorage error:",e)}}saveToStorageSafe(){if(!(typeof localStorage>"u"))try{const e={};for(const[r,i]of this.items.entries())e[r]=i;const t={version:1,items:e};localStorage.setItem(K,JSON.stringify(t))}catch(e){console.error("[ProfileCache] saveToStorageSafe error:",e)}}}const T={PROFILE_UPDATED:"profile.updated"};class ${constructor(e,t){this.cache=new de,this.meGid=null,this.getAuthToken=e,this.events=t}buildUrl(e){const t=p.authUrl.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}async request(e,t={}){const r=this.buildUrl(e),i=this.getAuthToken(),n={"Content-Type":"application/json",...t.headers};i&&(n.Authorization=`Bearer ${i}`);const c=await fetch(r,{...t,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch{}throw new Error(u)}const h=await c.text();return h?JSON.parse(h):null}async getMe(){if(this.meGid){const t=this.cache.get(this.meGid);if(t)return t}const e=await this.request("/v1/profile/me");return this.meGid=e.gid,this.cache.set(e,N),e}async getByGid(e){if(this.meGid===e)return this.getMe();const t=this.cache.get(e);if(t)return t;const r=await this.request(`/v1/profile/${e}`);return this.cache.set(r,le),r}async update(e){const t=await this.request("/v1/profile/me",{method:"PUT",body:JSON.stringify(e)});return this.meGid=t.gid,this.cache.set(t,N),this.events.emit(T.PROFILE_UPDATED,{gid:t.gid,profile:t}),typeof window<"u"&&window.dispatchEvent(new CustomEvent(T.PROFILE_UPDATED,{detail:{gid:t.gid,profile:t}})),t}async getSummary(e){let t=e;return t||(t=(await this.getMe()).gid),this.request(`/v1/profile/${t}/summary`)}async getSummaryBatch(e){return(await this.request("/v1/profile/batch",{method:"POST",body:JSON.stringify({gids:e})})).profiles??[]}invalidate(e){this.cache.invalidate(e)}invalidateAll(){this.cache.invalidateAll()}}class M{constructor(e){this.getAuthToken=e}buildUrl(e){const t=p.baseUrl.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}async request(e,t={}){const r=this.buildUrl(e),i=this.getAuthToken(),n={"Content-Type":"application/json",...t.headers};i&&(n.Authorization=`Bearer ${i}`),console.log("[API] REQUEST:",{url:r,method:t.method??"GET",headers:n,body:t.body});const c=await fetch(r,{...t,headers:n,credentials:"include"});if(!c.ok){const l=await c.text().catch(()=>"");throw console.error("[API] Request failed:",{url:r,status:c.status,body:l}),new Error(`Request failed with status ${c.status}`)}const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(l){return console.warn("[API] Response is not JSON, returning as text:",l),h}}normalizeBody(e){return e===void 0?void 0:JSON.stringify(e)}send(e,t,r){return this.request(t,{method:e,body:this.normalizeBody(r)})}get(e){return this.send("GET",e)}post(e,t){return this.send("POST",e,t)}put(e,t){return this.send("PUT",e,t)}patch(e,t){return this.send("PATCH",e,t)}delete(e){return this.send("DELETE",e)}}class B{constructor(){this.listeners=new Map,this.onceListeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){this.listeners.get(e)?.delete(t),this.onceListeners.get(e)?.delete(t)}emit(e,...t){this.listeners.get(e)?.forEach(i=>i(...t));const r=this.onceListeners.get(e);r&&(r.forEach(i=>i(...t)),this.onceListeners.delete(e))}}const _=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,d=globalThis,y="10.27.0";function q(){return A(d),d}function A(s){const e=s.__SENTRY__=s.__SENTRY__||{};return e.version=e.version||y,e[y]=e[y]||{}}function b(s,e,t=d){const r=t.__SENTRY__=t.__SENTRY__||{},i=r[y]=r[y]||{};return i[s]||(i[s]=e())}const fe="Sentry Logger ",x={};function pe(s){if(!("console"in d))return s();const e=d.console,t={},r=Object.keys(x);r.forEach(i=>{const n=x[i];t[i]=e[i],e[i]=n});try{return s()}finally{r.forEach(i=>{e[i]=t[i]})}}function ge(){P().enabled=!0}function me(){P().enabled=!1}function G(){return P().enabled}function _e(...s){D("log",...s)}function Se(...s){D("warn",...s)}function ye(...s){D("error",...s)}function D(s,...e){_&&G()&&pe(()=>{d.console[s](`${fe}[${s}]:`,...e)})}function P(){return _?b("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const E={enable:ge,disable:me,isEnabled:G,log:_e,warn:Se,error:ye},ve=Object.prototype.toString;function Ee(s,e){return ve.call(s)===`[object ${e}]`}function Ce(s){return Ee(s,"Object")}function we(s){return!!(s?.then&&typeof s.then=="function")}function Te(s,e,t){try{Object.defineProperty(s,e,{value:t,writable:!0,configurable:!0})}catch{_&&E.log(`Failed to add non-enumerable property "${e}" to object`,s)}}function Ae(s,e=0){return typeof s!="string"||e===0||s.length<=e?s:`${s.slice(0,e)}...`}function be(){const s=d;return s.crypto||s.msCrypto}let I;function De(){return Math.random()*16}function v(s=be()){try{if(s?.randomUUID)return s.randomUUID().replace(/-/g,"")}catch{}return I||(I="10000000100040008000"+1e11),I.replace(/[018]/g,e=>(e^(De()&15)>>e/4).toString(16))}const F=1e3;function J(){return Date.now()/F}function Pe(){const{performance:s}=d;if(!s?.now||!s.timeOrigin)return J;const e=s.timeOrigin;return()=>(e+s.now())/F}let V;function Ie(){return(V??(V=Pe()))()}function Re(s,e={}){if(e.user&&(!s.ipAddress&&e.user.ip_address&&(s.ipAddress=e.user.ip_address),!s.did&&!e.did&&(s.did=e.user.id||e.user.email||e.user.username)),s.timestamp=e.timestamp||Ie(),e.abnormal_mechanism&&(s.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(s.ignoreDuration=e.ignoreDuration),e.sid&&(s.sid=e.sid.length===32?e.sid:v()),e.init!==void 0&&(s.init=e.init),!s.did&&e.did&&(s.did=`${e.did}`),typeof e.started=="number"&&(s.started=e.started),s.ignoreDuration)s.duration=void 0;else if(typeof e.duration=="number")s.duration=e.duration;else{const t=s.timestamp-s.started;s.duration=t>=0?t:0}e.release&&(s.release=e.release),e.environment&&(s.environment=e.environment),!s.ipAddress&&e.ipAddress&&(s.ipAddress=e.ipAddress),!s.userAgent&&e.userAgent&&(s.userAgent=e.userAgent),typeof e.errors=="number"&&(s.errors=e.errors),e.status&&(s.status=e.status)}function j(s,e,t=2){if(!e||typeof e!="object"||t<=0)return e;if(s&&Object.keys(e).length===0)return s;const r={...s};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=j(r[i],e[i],t-1));return r}function H(){return v()}const R="_sentrySpan";function z(s,e){e?Te(s,R,e):delete s[R]}function Y(s){return s[R]}const Oe=100;class g{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._attributes={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:H(),sampleRand:Math.random()}}clone(){const e=new g;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._attributes={...this._attributes},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,z(e,Y(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&Re(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this.setTags({[e]:t})}setAttributes(e){return this._attributes={...this._attributes,...e},this._notifyScopeListeners(),this}setAttribute(e,t){return this.setAttributes({[e]:t})}removeAttribute(e){return e in this._attributes&&(delete this._attributes[e],this._notifyScopeListeners()),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t=typeof e=="function"?e(this):e,r=t instanceof g?t.getScopeData():Ce(t)?e:void 0,{tags:i,attributes:n,extra:c,user:h,contexts:l,level:u,fingerprint:a=[],propagationContext:ae}=r||{};return this._tags={...this._tags,...i},this._attributes={...this._attributes,...n},this._extra={...this._extra,...c},this._contexts={...this._contexts,...l},h&&Object.keys(h).length&&(this._user=h),u&&(this._level=u),a.length&&(this._fingerprint=a),ae&&(this._propagationContext=ae),this}clear(){return this._breadcrumbs=[],this._tags={},this._attributes={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,z(this,void 0),this._attachments=[],this.setPropagationContext({traceId:H(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const r=typeof t=="number"?t:Oe;if(r<=0)return this;const i={timestamp:J(),...e,message:e.message?Ae(e.message,2048):e.message};return this._breadcrumbs.push(i),this._breadcrumbs.length>r&&(this._breadcrumbs=this._breadcrumbs.slice(-r),this._client?.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,attributes:this._attributes,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:Y(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=j(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext=e,this}getPropagationContext(){return this._propagationContext}captureException(e,t){const r=t?.event_id||v();if(!this._client)return _&&E.warn("No client configured on scope - will not capture exception!"),r;const i=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:i,...t,event_id:r},this),r}captureMessage(e,t,r){const i=r?.event_id||v();if(!this._client)return _&&E.warn("No client configured on scope - will not capture message!"),i;const n=r?.syntheticException??new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:n,...r,event_id:i},this),i}captureEvent(e,t){const r=t?.event_id||v();return this._client?(this._client.captureEvent(e,{...t,event_id:r},this),r):(_&&E.warn("No client configured on scope - will not capture event!"),r)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}function ke(){return b("defaultCurrentScope",()=>new g)}function Le(){return b("defaultIsolationScope",()=>new g)}class Ue{constructor(e,t){let r;e?r=e:r=new g;let i;t?i=t:i=new g,this._stack=[{scope:r}],this._isolationScope=i}withScope(e){const t=this._pushScope();let r;try{r=e(t)}catch(i){throw this._popScope(),i}return we(r)?r.then(i=>(this._popScope(),i),i=>{throw this._popScope(),i}):(this._popScope(),r)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return this._stack.length<=1?!1:!!this._stack.pop()}}function S(){const s=q(),e=A(s);return e.stack=e.stack||new Ue(ke(),Le())}function Ke(s){return S().withScope(s)}function Ne(s,e){const t=S();return t.withScope(()=>(t.getStackTop().scope=s,e(s)))}function W(s){return S().withScope(()=>s(S().getIsolationScope()))}function $e(){return{withIsolationScope:W,withScope:Ke,withSetScope:Ne,withSetIsolationScope:(s,e)=>W(e),getCurrentScope:()=>S().getScope(),getIsolationScope:()=>S().getIsolationScope()}}function Me(s){const e=A(s);return e.acs?e.acs:$e()}function Be(){const s=q();return Me(s).getCurrentScope()}function Je(s){}function qe(s,e){return Be().captureException(s,void 0)}class X{constructor(e){this.apiClient=e}async init(e){return this.apiClient.post("/v1/configs/init",e)}async fetch(e){return this.apiClient.post("/v1/configs/fetch",e)}}class Q{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/ab-tests")}async getActive(){return this.apiClient.get("/v1/ab-tests/active")}async getById(e){return this.apiClient.get(`/v1/ab-tests/${e}`)}async getVariant(e){return this.apiClient.get(`/v1/ab-tests/${e}/variant`)}async create(e){return this.apiClient.post("/v1/ab-tests",e)}async update(e,t){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"PUT",body:JSON.stringify(t)})}async patch(e,t){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"DELETE"})}}class Z{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/remote-configs")}async getById(e){return this.apiClient.get(`/v1/remote-configs/${e}`)}async create(e){return this.apiClient.post("/v1/remote-configs",e)}async update(e,t){return this.apiClient.request(`/v1/remote-configs/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/remote-configs/${e}`,{method:"DELETE"})}async refresh(){return this.apiClient.post("/v1/remote-configs/refresh",{})}}class ee{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/segments")}async getById(e){return this.apiClient.get(`/v1/segments/${e}`)}async getUserSegments(){return this.apiClient.get("/v1/segments/user")}async create(e){return this.apiClient.post("/v1/segments",e)}async update(e,t){return this.apiClient.request(`/v1/segments/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/segments/${e}`,{method:"DELETE"})}}class te{constructor(e){this.getAuthToken=e}buildUrl(e){const t=p.authUrl.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}async request(e,t={}){const r=this.buildUrl(e),i=this.getAuthToken(),n={"Content-Type":"application/json",...t.headers};i&&(n.Authorization=`Bearer ${i}`);const c=await fetch(r,{...t,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch{}throw new Error(u)}const h=await c.text();return h?JSON.parse(h):null}async getAll(){return this.request("/v1/users")}async getById(e){return this.request(`/v1/users/${e}`)}async search(e){return this.request(`/v1/users/search?q=${encodeURIComponent(e)}`)}async create(e){return this.request("/v1/users",{method:"POST",body:JSON.stringify(e)})}async update(e,t){return this.request(`/v1/users/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.request(`/v1/users/${e}`,{method:"DELETE"})}}class se{constructor(e){this.apiClient=e}async getVersion(){return this.apiClient.get("/v1")}async check(){return this.apiClient.get("/v1/health")}async detailed(){return this.apiClient.get("/v1/health/detailed")}}class re{constructor(e){this.getAuthToken=e}buildUrl(e){const t=p.authUrl.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}async request(e,t={}){const r=this.buildUrl(e),i=this.getAuthToken(),n={"Content-Type":"application/json",...t.headers};i&&(n.Authorization=`Bearer ${i}`);const c=await fetch(r,{...t,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch(a){console.error("[AuthApiClient] Error parsing error response:",a,"Raw:",l)}throw console.error("[AuthApiClient] Request failed:",{url:r,status:c.status,message:u}),new Error(u)}const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(l){return console.warn("[AuthApiClient] Response is not JSON, returning as text:",l),h}}async guest(e){return this.request("/v1/auth/guest",{method:"POST",body:JSON.stringify({deviceId:e})})}async login(e){return this.request("/v1/auth/login",{method:"POST",body:JSON.stringify(e)})}async register(e){return this.request("/v1/auth/registration",{method:"POST",body:JSON.stringify(e)})}async logout(){return this.request("/v1/auth/logout",{method:"POST"})}async getMe(){return this.request("/v1/auth/me",{method:"GET"})}async refresh(){return this.request("/v1/auth/refresh",{method:"POST"})}async health(){return this.request("/v1/health",{method:"GET"})}}class ie{constructor(e){this.apiClient=e}async health(){return this.apiClient.get("/v1/kv/health")}async list(){return this.apiClient.get("/v1/kv/list")}async get(e){return this.apiClient.get(`/v1/kv/get/${encodeURIComponent(e)}`)}async set(e,t){const r={key:e,value:t};return this.apiClient.post("/v1/kv/set",r)}async delete(e){return this.apiClient.delete(`/v1/kv/${encodeURIComponent(e)}`)}async exists(e){try{return await this.get(e),!0}catch(t){return console.debug("[KVApiClient] exists check failed for key:",e,t),!1}}async getMany(e){const t={},r=e.map(async i=>{try{const n=await this.get(i);t[i]=n.value}catch(n){console.debug("[KVApiClient] getMany failed for key:",i,n),t[i]=null}});return await Promise.all(r),t}async setMany(e){const t=Object.entries(e).map(([r,i])=>this.set(r,i));await Promise.all(t)}async deleteMany(e){const t=e.map(r=>this.delete(r));await Promise.all(t)}}class xe{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/events")}async send(e){return this.apiClient.post("/v1/events",e)}}const C="1.0.17",w=[C,"1.0.3"];function ne(s){return w.includes(s)}function oe(s){if(!ne(s)){const e=w.join(", ");throw new Error(`[SDK] Unsupported version "${s}". Supported versions: ${e}. Current SDK version: ${C}`)}}const Ge={AUTH_OPEN:"core:authWindowOpen",AUTH_CLOSE:"core:authWindowClose"};class m{constructor(){this.eventBus=new B,this.systemParams={},this.initialized=!1,this.detectEnvironment(),this.apiClient=new M(()=>this.systemParams.authToken),this.configs=new X(this.apiClient),this.abTests=new Q(this.apiClient),this.remoteConfigs=new Z(this.apiClient),this.segments=new ee(this.apiClient),this.users=new te(()=>this.systemParams.authToken),this.health=new se(this.apiClient),this.auth=new re(()=>this.systemParams.authToken),this.kv=new ie(this.apiClient),this.events=new xe(this.apiClient)}static getInstance(){return m.instance||(m.instance=new m),m.instance}async init(e){if(console.log(`[SDK] v${C} init: start`,e),e?.version){console.log(`[SDK] init: validating app version "${e.version}"...`);try{oe(e.version),console.log(`[SDK] init: app version "${e.version}" is supported`)}catch(r){throw console.error(`[SDK] init: VERSION ERROR - ${r.message}`),console.error(`[SDK] init: Supported versions: ${w.join(", ")}`),r}}const t=this.getStoredToken();if(t&&!this.systemParams.authToken&&(console.log("[SDK] init: RESTORING TOKEN FROM LOCALSTORAGE"),this.systemParams.authToken=t),this.systemParams.authToken){console.log("[SDK] init: TOKEN ALREADY SET → SKIP GUEST AUTH"),this.profileClient=new $(()=>this.systemParams.authToken,this.eventBus),this.initialized=!0;return}if(!this.initialized)try{e?.baseUrl&&(console.log("[SDK] init: set base url ->",e.baseUrl),L(e.baseUrl)),e?.authUrl&&(console.log("[SDK] init: set auth url ->",e.authUrl),U(e.authUrl)),console.log("[SDK] init: set system params ->",e),e&&this.setSystemParams(e),console.log("[SDK] init: ensure device id…");const r=await this.ensureDeviceId();console.log("[SDK] init: deviceId =",r),this.systemParams.deviceId=r,e?.skipAuth?console.log("[SDK] init: skipAuth=true, skipping guest auth"):(console.log("[SDK] init: guest auth…"),await this.authGuest(),console.log("[SDK] init: guest auth OK")),this.profileClient=new $(()=>this.systemParams.authToken,this.eventBus),console.log("[SDK] init: profile module initialized"),this.on(T.PROFILE_UPDATED,i=>{try{const n=i?.gid??i?.detail?.gid;n&&(console.log("[SDK] profile cache invalidated for",n),this.profileClient.invalidate(n))}catch(n){console.error("[SDK] profile cache invalidation error:",n)}}),this.initialized=!0,console.log("[SDK] init: COMPLETE"),this.eventBus.emit("core:initialized",this.getSystemParams())}catch(r){throw console.error("[SDK] init: ERROR",r),this.captureError(r),r}}captureError(e){try{qe(e)}catch(t){console.error("[SDK] Sentry capture error:",t)}}async authGuest(){try{console.log("[SDK] authGuest: start");const e=this.getStoredToken();if(e){this.systemParams.authToken=e;return}console.log("[SDK] authGuest: sending POST /v1/auth/guest",{deviceId:this.systemParams.deviceId});const t=await this.auth.guest(this.systemParams.deviceId);console.log("[SDK] authGuest: server response",t);const r=t?.accessToken??t?.data?.accessToken??null;if(!r)throw console.error("[SDK] authGuest: ERROR missing token",t),new Error("Guest auth failed: missing token");this.storeToken(r),this.systemParams.authToken=r}catch(e){throw console.error("[SDK] authGuest: ERROR",e),this.captureError(e),e}}setSystemParams(e){this.systemParams={...this.systemParams,...e}}getSystemParams(){return{...this.systemParams}}get api(){return this.apiClient}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}emit(e,...t){this.eventBus.emit(e,...t)}detectEnvironment(){const e=typeof navigator<"u"?navigator.userAgent:"",t=typeof window<"u"&&typeof window.cordova<"u";this.systemParams.os=this.detectOS(e),this.systemParams.isCordova=t}detectOS(e){return/android/i.test(e)?"android":/iPad|iPhone|iPod/i.test(e)?"ios":/Win/i.test(e)?"windows":/Mac/i.test(e)?"macos":/Linux/i.test(e)?"linux":"unknown"}async ensureDeviceId(){const e=this.getStoredDeviceId();if(e)return e;const t=await this.tryGetCordovaDeviceId();if(t)return this.storeDeviceId(t),t;const r=this.generateGuid();return this.storeDeviceId(r),r}getStoredDeviceId(){try{return localStorage.getItem("coreSDK_deviceId")}catch(e){return console.error("[SDK] getStoredDeviceId error:",e),null}}storeDeviceId(e){try{localStorage.setItem("coreSDK_deviceId",e)}catch(t){console.error("[SDK] storeDeviceId error:",t)}}getStoredToken(){try{return localStorage.getItem("coreSDK_token")}catch(e){return console.error("[SDK] getStoredToken error:",e),null}}storeToken(e){try{localStorage.setItem("coreSDK_token",e)}catch(t){console.error("[SDK] storeToken error:",t)}}setUser(e){this.systemParams.user=e}async login(e){try{console.log("[SDK] login: start",{email:e.email});const t=await this.auth.login(e);console.log("[SDK] login: server response received");const r=t?.accessToken??null;if(!r)throw console.error("[SDK] login: ERROR missing token",t),new Error("Login failed: missing token");return this.storeToken(r),this.systemParams.authToken=r,t.user&&this.setUser(t.user),t}catch(t){throw console.error("[SDK] login: ERROR",t),this.captureError(t),t}}async register(e){try{console.log("[SDK] register: start",{email:e.email,username:e.username});const t=await this.auth.register(e);if(console.log("[SDK] register: server response received"),!t)throw console.error("[SDK] register: ERROR missing user data"),new Error("Registration failed: missing user data");return t}catch(t){throw console.error("[SDK] register: ERROR",t),this.captureError(t),t}}async logout(){try{console.log("[SDK] logout: start");try{await this.auth.logout()}catch(e){console.warn("[SDK] logout endpoint error (ignored):",e)}this.clearToken(),this.systemParams.authToken=void 0,this.systemParams.user=null,console.log("[SDK] logout: COMPLETE")}catch(e){throw console.error("[SDK] logout: ERROR",e),this.captureError(e),e}}clearToken(){try{localStorage.removeItem("coreSDK_token")}catch(e){console.error("[SDK] clearToken error:",e)}}async tryGetCordovaDeviceId(){if(typeof window>"u")return null;const e=window;return e.device?.uuid?String(e.device.uuid):null}generateGuid(){const e=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}get profile(){return this.profileClient}}const Fe=m.getInstance();o.AbTestsApiClient=Q,o.ApiClient=M,o.AuthApiClient=re,o.ConfigsApiClient=X,o.CoreSDK=m,o.EventBus=B,o.HealthApiClient=se,o.KVApiClient=ie,o.RemoteConfigsApiClient=Z,o.SDK_EVENTS=Ge,o.SDK_VERSION=C,o.SUPPORTED_VERSIONS=w,o.SegmentsApiClient=ee,o.UsersApiClient=te,o.coreSDK=Fe,o.isVersionSupported=ne,o.sdkConfig=p,o.setAuthUrl=U,o.setBaseUrl=L,o.validateVersion=oe,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
