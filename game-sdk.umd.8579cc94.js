(function(o,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(o=typeof globalThis<"u"?globalThis:o||self,f(o.coreSDK={}))})(this,(function(o){"use strict";var f=typeof document<"u"?document.currentScript:null;const O={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};function k(s){if(typeof process<"u"&&process.env){const t=process.env[s];if(t)return t}if(typeof{url:typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:f&&f.tagName.toUpperCase()==="SCRIPT"&&f.src||new URL("game-sdk.umd.js",document.baseURI).href}<"u"&&O){const t=O[s];if(t)return t}if(typeof window<"u"&&window.__ENV__){const t=window.__ENV__[s];if(t)return t}}const ut=k("REACT_APP_BACKEND_URL")||"https://configs.artintgames.com",ht=k("REACT_APP_BACKEND_URL_AUTH")||"https://auth.artintgames.com",g={baseUrl:ut,authUrl:ht};function L(s){g.baseUrl=s}function U(s){g.authUrl=s}const K="coreSDK_profiles_v1",lt=100,N=300*1e3,dt=600*1e3;class ft{constructor(t){this.items=new Map,this.maxItems=t?.maxItems??lt,this.loadFromStorage()}get(t){const e=this.items.get(t);if(!e)return null;const i=Date.now();return i-e.cachedAt>e.ttl?(this.items.delete(t),this.saveToStorageSafe(),null):(e.lastAccessed=i,e.profile)}set(t,e){const i=Date.now(),r={profile:t,cachedAt:i,lastAccessed:i,ttl:e};this.items.set(t.gid,r),this.evictIfNeeded(),this.saveToStorageSafe()}invalidate(t){this.items.delete(t)&&this.saveToStorageSafe()}invalidateAll(){this.items.clear(),this.saveToStorageSafe()}evictIfNeeded(){if(this.items.size<=this.maxItems)return;const t=Array.from(this.items.entries());t.sort((i,r)=>i[1].lastAccessed-r[1].lastAccessed);const e=t.length-this.maxItems;for(let i=0;i<e;i++){const[r]=t[i];this.items.delete(r)}}loadFromStorage(){if(!(typeof localStorage>"u"))try{const t=localStorage.getItem(K);if(!t)return;const e=JSON.parse(t);if(e.version!==1||!e.items||typeof e.items!="object")return;const i=Date.now();for(const[r,n]of Object.entries(e.items))!n||!n.profile||typeof n.cachedAt!="number"||typeof n.ttl!="number"||i-n.cachedAt>n.ttl||this.items.set(r,n);this.evictIfNeeded()}catch(t){console.error("[ProfileCache] loadFromStorage error:",t)}}saveToStorageSafe(){if(!(typeof localStorage>"u"))try{const t={};for(const[i,r]of this.items.entries())t[i]=r;const e={version:1,items:t};localStorage.setItem(K,JSON.stringify(e))}catch(t){console.error("[ProfileCache] saveToStorageSafe error:",t)}}}const T={PROFILE_UPDATED:"profile.updated"};class ${constructor(t,e){this.cache=new ft,this.meGid=null,this.getAuthToken=t,this.events=e}buildUrl(t){const e=g.authUrl.replace(/\/+$/,""),i=t.replace(/^\/+/,"");return`${e}/${i}`}async request(t,e={}){const i=this.buildUrl(t),r=this.getAuthToken(),n={"Content-Type":"application/json",...e.headers};r&&(n.Authorization=`Bearer ${r}`);const c=await fetch(i,{...e,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch{}throw new Error(u)}const h=await c.text();return h?JSON.parse(h):null}async getMe(){if(this.meGid){const e=this.cache.get(this.meGid);if(e)return e}const t=await this.request("/v1/profile/me");return this.meGid=t.gid,this.cache.set(t,N),t}async getByGid(t){if(this.meGid===t)return this.getMe();const e=this.cache.get(t);if(e)return e;const i=await this.request(`/v1/profile/${t}`);return this.cache.set(i,dt),i}async update(t){const e=await this.request("/v1/profile/me",{method:"PUT",body:JSON.stringify(t)});return this.meGid=e.gid,this.cache.set(e,N),this.events.emit(T.PROFILE_UPDATED,{gid:e.gid,profile:e}),typeof window<"u"&&window.dispatchEvent(new CustomEvent(T.PROFILE_UPDATED,{detail:{gid:e.gid,profile:e}})),e}async getSummary(t){let e=t;return e||(e=(await this.getMe()).gid),this.request(`/v1/profile/${e}/summary`)}async getSummaryBatch(t){return(await this.request("/v1/profile/batch",{method:"POST",body:JSON.stringify({gids:t})})).profiles??[]}invalidate(t){this.cache.invalidate(t)}invalidateAll(){this.cache.invalidateAll()}}class M{constructor(t){this.getAuthToken=t}buildUrl(t){const e=g.baseUrl.replace(/\/+$/,""),i=t.replace(/^\/+/,"");return`${e}/${i}`}async request(t,e={}){const i=this.buildUrl(t),r=this.getAuthToken(),n={"Content-Type":"application/json",...e.headers};r&&(n.Authorization=`Bearer ${r}`),console.log("[API] REQUEST:",{url:i,method:e.method??"GET",headers:n,body:e.body});const c=await fetch(i,{...e,headers:n,credentials:"include"});if(!c.ok){const l=await c.text().catch(()=>"");throw console.error("[API] Request failed:",{url:i,status:c.status,body:l}),new Error(`Request failed with status ${c.status}`)}const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(l){return console.warn("[API] Response is not JSON, returning as text:",l),h}}normalizeBody(t){return t===void 0?void 0:JSON.stringify(t)}send(t,e,i){return this.request(e,{method:t,body:this.normalizeBody(i)})}get(t){return this.send("GET",t)}post(t,e){return this.send("POST",t,e)}put(t,e){return this.send("PUT",t,e)}patch(t,e){return this.send("PATCH",t,e)}delete(t){return this.send("DELETE",t)}}class B{constructor(){this.listeners=new Map,this.onceListeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}once(t,e){this.onceListeners.has(t)||this.onceListeners.set(t,new Set),this.onceListeners.get(t).add(e)}off(t,e){this.listeners.get(t)?.delete(e),this.onceListeners.get(t)?.delete(e)}emit(t,...e){this.listeners.get(t)?.forEach(r=>r(...e));const i=this.onceListeners.get(t);i&&(i.forEach(r=>r(...e)),this.onceListeners.delete(t))}}const _=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,d=globalThis,y="10.27.0";function q(){return A(d),d}function A(s){const t=s.__SENTRY__=s.__SENTRY__||{};return t.version=t.version||y,t[y]=t[y]||{}}function b(s,t,e=d){const i=e.__SENTRY__=e.__SENTRY__||{},r=i[y]=i[y]||{};return r[s]||(r[s]=t())}const gt="Sentry Logger ",x={};function pt(s){if(!("console"in d))return s();const t=d.console,e={},i=Object.keys(x);i.forEach(r=>{const n=x[r];e[r]=t[r],t[r]=n});try{return s()}finally{i.forEach(r=>{t[r]=e[r]})}}function mt(){P().enabled=!0}function _t(){P().enabled=!1}function G(){return P().enabled}function St(...s){D("log",...s)}function yt(...s){D("warn",...s)}function vt(...s){D("error",...s)}function D(s,...t){_&&G()&&pt(()=>{d.console[s](`${gt}[${s}]:`,...t)})}function P(){return _?b("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const E={enable:mt,disable:_t,isEnabled:G,log:St,warn:yt,error:vt},Et=Object.prototype.toString;function Ct(s,t){return Et.call(s)===`[object ${t}]`}function wt(s){return Ct(s,"Object")}function Tt(s){return!!(s?.then&&typeof s.then=="function")}function At(s,t,e){try{Object.defineProperty(s,t,{value:e,writable:!0,configurable:!0})}catch{_&&E.log(`Failed to add non-enumerable property "${t}" to object`,s)}}function bt(s,t=0){return typeof s!="string"||t===0||s.length<=t?s:`${s.slice(0,t)}...`}function Dt(){const s=d;return s.crypto||s.msCrypto}let I;function Pt(){return Math.random()*16}function v(s=Dt()){try{if(s?.randomUUID)return s.randomUUID().replace(/-/g,"")}catch{}return I||(I="10000000100040008000"+1e11),I.replace(/[018]/g,t=>(t^(Pt()&15)>>t/4).toString(16))}const F=1e3;function J(){return Date.now()/F}function It(){const{performance:s}=d;if(!s?.now||!s.timeOrigin)return J;const t=s.timeOrigin;return()=>(t+s.now())/F}let V;function Rt(){return(V??(V=It()))()}function Ot(s,t={}){if(t.user&&(!s.ipAddress&&t.user.ip_address&&(s.ipAddress=t.user.ip_address),!s.did&&!t.did&&(s.did=t.user.id||t.user.email||t.user.username)),s.timestamp=t.timestamp||Rt(),t.abnormal_mechanism&&(s.abnormal_mechanism=t.abnormal_mechanism),t.ignoreDuration&&(s.ignoreDuration=t.ignoreDuration),t.sid&&(s.sid=t.sid.length===32?t.sid:v()),t.init!==void 0&&(s.init=t.init),!s.did&&t.did&&(s.did=`${t.did}`),typeof t.started=="number"&&(s.started=t.started),s.ignoreDuration)s.duration=void 0;else if(typeof t.duration=="number")s.duration=t.duration;else{const e=s.timestamp-s.started;s.duration=e>=0?e:0}t.release&&(s.release=t.release),t.environment&&(s.environment=t.environment),!s.ipAddress&&t.ipAddress&&(s.ipAddress=t.ipAddress),!s.userAgent&&t.userAgent&&(s.userAgent=t.userAgent),typeof t.errors=="number"&&(s.errors=t.errors),t.status&&(s.status=t.status)}function j(s,t,e=2){if(!t||typeof t!="object"||e<=0)return t;if(s&&Object.keys(t).length===0)return s;const i={...s};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(i[r]=j(i[r],t[r],e-1));return i}function H(){return v()}const R="_sentrySpan";function z(s,t){t?At(s,R,t):delete s[R]}function Y(s){return s[R]}const kt=100;class p{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._attributes={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:H(),sampleRand:Math.random()}}clone(){const t=new p;return t._breadcrumbs=[...this._breadcrumbs],t._tags={...this._tags},t._attributes={...this._attributes},t._extra={...this._extra},t._contexts={...this._contexts},this._contexts.flags&&(t._contexts.flags={values:[...this._contexts.flags.values]}),t._user=this._user,t._level=this._level,t._session=this._session,t._transactionName=this._transactionName,t._fingerprint=this._fingerprint,t._eventProcessors=[...this._eventProcessors],t._attachments=[...this._attachments],t._sdkProcessingMetadata={...this._sdkProcessingMetadata},t._propagationContext={...this._propagationContext},t._client=this._client,t._lastEventId=this._lastEventId,z(t,Y(this)),t}setClient(t){this._client=t}setLastEventId(t){this._lastEventId=t}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(t){this._scopeListeners.push(t)}addEventProcessor(t){return this._eventProcessors.push(t),this}setUser(t){return this._user=t||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&Ot(this._session,{user:t}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(t){return this._tags={...this._tags,...t},this._notifyScopeListeners(),this}setTag(t,e){return this.setTags({[t]:e})}setAttributes(t){return this._attributes={...this._attributes,...t},this._notifyScopeListeners(),this}setAttribute(t,e){return this.setAttributes({[t]:e})}removeAttribute(t){return t in this._attributes&&(delete this._attributes[t],this._notifyScopeListeners()),this}setExtras(t){return this._extra={...this._extra,...t},this._notifyScopeListeners(),this}setExtra(t,e){return this._extra={...this._extra,[t]:e},this._notifyScopeListeners(),this}setFingerprint(t){return this._fingerprint=t,this._notifyScopeListeners(),this}setLevel(t){return this._level=t,this._notifyScopeListeners(),this}setTransactionName(t){return this._transactionName=t,this._notifyScopeListeners(),this}setContext(t,e){return e===null?delete this._contexts[t]:this._contexts[t]=e,this._notifyScopeListeners(),this}setSession(t){return t?this._session=t:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(t){if(!t)return this;const e=typeof t=="function"?t(this):t,i=e instanceof p?e.getScopeData():wt(e)?t:void 0,{tags:r,attributes:n,extra:c,user:h,contexts:l,level:u,fingerprint:a=[],propagationContext:ct}=i||{};return this._tags={...this._tags,...r},this._attributes={...this._attributes,...n},this._extra={...this._extra,...c},this._contexts={...this._contexts,...l},h&&Object.keys(h).length&&(this._user=h),u&&(this._level=u),a.length&&(this._fingerprint=a),ct&&(this._propagationContext=ct),this}clear(){return this._breadcrumbs=[],this._tags={},this._attributes={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,z(this,void 0),this._attachments=[],this.setPropagationContext({traceId:H(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(t,e){const i=typeof e=="number"?e:kt;if(i<=0)return this;const r={timestamp:J(),...t,message:t.message?bt(t.message,2048):t.message};return this._breadcrumbs.push(r),this._breadcrumbs.length>i&&(this._breadcrumbs=this._breadcrumbs.slice(-i),this._client?.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(t){return this._attachments.push(t),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,attributes:this._attributes,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:Y(this)}}setSDKProcessingMetadata(t){return this._sdkProcessingMetadata=j(this._sdkProcessingMetadata,t,2),this}setPropagationContext(t){return this._propagationContext=t,this}getPropagationContext(){return this._propagationContext}captureException(t,e){const i=e?.event_id||v();if(!this._client)return _&&E.warn("No client configured on scope - will not capture exception!"),i;const r=new Error("Sentry syntheticException");return this._client.captureException(t,{originalException:t,syntheticException:r,...e,event_id:i},this),i}captureMessage(t,e,i){const r=i?.event_id||v();if(!this._client)return _&&E.warn("No client configured on scope - will not capture message!"),r;const n=i?.syntheticException??new Error(t);return this._client.captureMessage(t,e,{originalException:t,syntheticException:n,...i,event_id:r},this),r}captureEvent(t,e){const i=e?.event_id||v();return this._client?(this._client.captureEvent(t,{...e,event_id:i},this),i):(_&&E.warn("No client configured on scope - will not capture event!"),i)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(t=>{t(this)}),this._notifyingListeners=!1)}}function Lt(){return b("defaultCurrentScope",()=>new p)}function Ut(){return b("defaultIsolationScope",()=>new p)}class Kt{constructor(t,e){let i;t?i=t:i=new p;let r;e?r=e:r=new p,this._stack=[{scope:i}],this._isolationScope=r}withScope(t){const e=this._pushScope();let i;try{i=t(e)}catch(r){throw this._popScope(),r}return Tt(i)?i.then(r=>(this._popScope(),r),r=>{throw this._popScope(),r}):(this._popScope(),i)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const t=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:t}),t}_popScope(){return this._stack.length<=1?!1:!!this._stack.pop()}}function S(){const s=q(),t=A(s);return t.stack=t.stack||new Kt(Lt(),Ut())}function Nt(s){return S().withScope(s)}function $t(s,t){const e=S();return e.withScope(()=>(e.getStackTop().scope=s,t(s)))}function W(s){return S().withScope(()=>s(S().getIsolationScope()))}function Mt(){return{withIsolationScope:W,withScope:Nt,withSetScope:$t,withSetIsolationScope:(s,t)=>W(t),getCurrentScope:()=>S().getScope(),getIsolationScope:()=>S().getIsolationScope()}}function Bt(s){const t=A(s);return t.acs?t.acs:Mt()}function qt(){const s=q();return Bt(s).getCurrentScope()}function jt(s){}function xt(s,t){return qt().captureException(s,void 0)}class X{constructor(t){this.apiClient=t}async init(t){return this.apiClient.post("/v1/configs/init",t)}async fetch(t){return this.apiClient.post("/v1/configs/fetch",t)}}class Q{constructor(t){this.apiClient=t}async getAll(){return this.apiClient.get("/v1/ab-tests")}async getActive(){return this.apiClient.get("/v1/ab-tests/active")}async getById(t){return this.apiClient.get(`/v1/ab-tests/${t}`)}async getVariant(t){return this.apiClient.get(`/v1/ab-tests/${t}/variant`)}async create(t){return this.apiClient.post("/v1/ab-tests",t)}async update(t,e){return this.apiClient.request(`/v1/ab-tests/${t}`,{method:"PUT",body:JSON.stringify(e)})}async patch(t,e){return this.apiClient.request(`/v1/ab-tests/${t}`,{method:"PATCH",body:JSON.stringify(e)})}async delete(t){return this.apiClient.request(`/v1/ab-tests/${t}`,{method:"DELETE"})}}class Z{constructor(t){this.apiClient=t}async getAll(){return this.apiClient.get("/v1/remote-configs")}async getById(t){return this.apiClient.get(`/v1/remote-configs/${t}`)}async create(t){return this.apiClient.post("/v1/remote-configs",t)}async update(t,e){return this.apiClient.request(`/v1/remote-configs/${t}`,{method:"PATCH",body:JSON.stringify(e)})}async delete(t){return this.apiClient.request(`/v1/remote-configs/${t}`,{method:"DELETE"})}async refresh(){return this.apiClient.post("/v1/remote-configs/refresh",{})}}class tt{constructor(t){this.apiClient=t}async getAll(){return this.apiClient.get("/v1/segments")}async getById(t){return this.apiClient.get(`/v1/segments/${t}`)}async getUserSegments(){return this.apiClient.get("/v1/segments/user")}async create(t){return this.apiClient.post("/v1/segments",t)}async update(t,e){return this.apiClient.request(`/v1/segments/${t}`,{method:"PATCH",body:JSON.stringify(e)})}async delete(t){return this.apiClient.request(`/v1/segments/${t}`,{method:"DELETE"})}}class et{constructor(t){this.getAuthToken=t}buildUrl(t){const e=g.authUrl.replace(/\/+$/,""),i=t.replace(/^\/+/,"");return`${e}/${i}`}async request(t,e={}){const i=this.buildUrl(t),r=this.getAuthToken(),n={"Content-Type":"application/json",...e.headers};r&&(n.Authorization=`Bearer ${r}`);const c=await fetch(i,{...e,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch{}throw new Error(u)}const h=await c.text();return h?JSON.parse(h):null}async getAll(){return this.request("/v1/users")}async getById(t){return this.request(`/v1/users/${t}`)}async search(t){return this.request(`/v1/users/search?q=${encodeURIComponent(t)}`)}async create(t){return this.request("/v1/users",{method:"POST",body:JSON.stringify(t)})}async update(t,e){return this.request(`/v1/users/${t}`,{method:"PATCH",body:JSON.stringify(e)})}async delete(t){return this.request(`/v1/users/${t}`,{method:"DELETE"})}}class st{constructor(t){this.apiClient=t}async getVersion(){return this.apiClient.get("/v1")}async check(){return this.apiClient.get("/v1/health")}async detailed(){return this.apiClient.get("/v1/health/detailed")}}class it{constructor(t){this.getAuthToken=t}buildUrl(t){const e=g.authUrl.replace(/\/+$/,""),i=t.replace(/^\/+/,"");return`${e}/${i}`}async request(t,e={}){const i=this.buildUrl(t),r=this.getAuthToken(),n={"Content-Type":"application/json",...e.headers};r&&(n.Authorization=`Bearer ${r}`);const c=await fetch(i,{...e,headers:n,credentials:"include"});if(!c.ok){const l=await c.text();let u=`Request failed with status ${c.status}`;try{const a=JSON.parse(l);Array.isArray(a.message)?u=a.message.join(", "):a.message?u=a.message:a.error&&(u=a.error)}catch(a){console.error("[AuthApiClient] Error parsing error response:",a,"Raw:",l)}throw console.error("[AuthApiClient] Request failed:",{url:i,status:c.status,message:u}),new Error(u)}const h=await c.text();if(!h)return null;try{return JSON.parse(h)}catch(l){return console.warn("[AuthApiClient] Response is not JSON, returning as text:",l),h}}async guest(t){return this.request("/v1/auth/guest",{method:"POST",body:JSON.stringify({deviceId:t})})}async login(t){return this.request("/v1/auth/login",{method:"POST",body:JSON.stringify(t)})}async register(t){return this.request("/v1/auth/registration",{method:"POST",body:JSON.stringify(t)})}async logout(){return this.request("/v1/auth/logout",{method:"POST"})}async getMe(){return this.request("/v1/auth/me",{method:"GET"})}async refresh(){return this.request("/v1/auth/refresh",{method:"POST"})}async health(){return this.request("/v1/health",{method:"GET"})}}class rt{constructor(t){this.apiClient=t}async health(){return this.apiClient.get("/v1/kv/health")}async list(){return this.apiClient.get("/v1/kv/list")}async get(t){return this.apiClient.get(`/v1/kv/get/${encodeURIComponent(t)}`)}async set(t,e){const i={key:t,value:e};return this.apiClient.post("/v1/kv/set",i)}async delete(t){return this.apiClient.delete(`/v1/kv/${encodeURIComponent(t)}`)}async exists(t){try{return await this.get(t),!0}catch(e){return console.debug("[KVApiClient] exists check failed for key:",t,e),!1}}async getMany(t){const e={},i=t.map(async r=>{try{const n=await this.get(r);e[r]=n.value}catch(n){console.debug("[KVApiClient] getMany failed for key:",r,n),e[r]=null}});return await Promise.all(i),e}async setMany(t){const e=Object.entries(t).map(([i,r])=>this.set(i,r));await Promise.all(e)}async deleteMany(t){const e=t.map(i=>this.delete(i));await Promise.all(e)}}class Gt{constructor(t){this.apiClient=t}async getAll(){return this.apiClient.get("/v1/events")}async send(t){return this.apiClient.post("/v1/events",t)}}const C="1.0.20",w=[C,"1.0.3"];function nt(s){return w.includes(s)}function ot(s){if(!nt(s)){const t=w.join(", ");throw new Error(`[SDK] Unsupported version "${s}". Supported versions: ${t}. Current SDK version: ${C}`)}}const Ft={AUTH_OPEN:"core:authWindowOpen",AUTH_CLOSE:"core:authWindowClose"};class m{constructor(){this.eventBus=new B,this.systemParams={},this.initialized=!1,this.detectEnvironment(),this.apiClient=new M(()=>this.systemParams.authToken),this.configs=new X(this.apiClient),this.abTests=new Q(this.apiClient),this.remoteConfigs=new Z(this.apiClient),this.segments=new tt(this.apiClient),this.users=new et(()=>this.systemParams.authToken),this.health=new st(this.apiClient),this.auth=new it(()=>this.systemParams.authToken),this.kv=new rt(this.apiClient),this.events=new Gt(this.apiClient)}static getInstance(){return m.instance||(m.instance=new m),m.instance}async init(t){if(console.log(`[SDK] v${C} init: start`,t),t?.version){console.log(`[SDK] init: validating app version "${t.version}"...`);try{ot(t.version),console.log(`[SDK] init: app version "${t.version}" is supported`)}catch(i){throw console.error(`[SDK] init: VERSION ERROR - ${i.message}`),console.error(`[SDK] init: Supported versions: ${w.join(", ")}`),i}}const e=this.getStoredToken();if(e&&!this.systemParams.authToken&&(console.log("[SDK] init: RESTORING TOKEN FROM LOCALSTORAGE"),this.systemParams.authToken=e),this.systemParams.authToken){console.log("[SDK] init: TOKEN ALREADY SET → SKIP GUEST AUTH"),this.profileClient=new $(()=>this.systemParams.authToken,this.eventBus),this.initialized=!0;return}if(!this.initialized)try{t?.baseUrl&&(console.log("[SDK] init: set base url ->",t.baseUrl),L(t.baseUrl)),t?.authUrl&&(console.log("[SDK] init: set auth url ->",t.authUrl),U(t.authUrl)),console.log("[SDK] init: set system params ->",t),t&&this.setSystemParams(t),console.log("[SDK] init: ensure device id…");const i=await this.ensureDeviceId();console.log("[SDK] init: deviceId =",i),this.systemParams.deviceId=i,t?.skipAuth?console.log("[SDK] init: skipAuth=true, skipping guest auth"):(console.log("[SDK] init: guest auth…"),await this.authGuest(),console.log("[SDK] init: guest auth OK")),this.profileClient=new $(()=>this.systemParams.authToken,this.eventBus),console.log("[SDK] init: profile module initialized"),this.on(T.PROFILE_UPDATED,r=>{try{const n=r?.gid??r?.detail?.gid;n&&(console.log("[SDK] profile cache invalidated for",n),this.profileClient.invalidate(n))}catch(n){console.error("[SDK] profile cache invalidation error:",n)}}),this.initialized=!0,console.log("[SDK] init: COMPLETE"),this.eventBus.emit("core:initialized",this.getSystemParams())}catch(i){throw console.error("[SDK] init: ERROR",i),this.captureError(i),i}}captureError(t){try{xt(t)}catch(e){console.error("[SDK] Sentry capture error:",e)}}async authGuest(){try{console.log("[SDK] authGuest: start");const t=this.getStoredToken();if(t){this.systemParams.authToken=t;return}console.log("[SDK] authGuest: sending POST /v1/auth/guest",{deviceId:this.systemParams.deviceId});const e=await this.auth.guest(this.systemParams.deviceId);console.log("[SDK] authGuest: server response",e);const i=e?.accessToken??e?.data?.accessToken??null;if(!i)throw console.error("[SDK] authGuest: ERROR missing token",e),new Error("Guest auth failed: missing token");this.storeToken(i),this.systemParams.authToken=i}catch(t){throw console.error("[SDK] authGuest: ERROR",t),this.captureError(t),t}}setSystemParams(t){this.systemParams={...this.systemParams,...t}}getSystemParams(){return{...this.systemParams}}get api(){return this.apiClient}on(t,e){this.eventBus.on(t,e)}once(t,e){this.eventBus.once(t,e)}off(t,e){this.eventBus.off(t,e)}emit(t,...e){this.eventBus.emit(t,...e)}detectEnvironment(){const t=typeof navigator<"u"?navigator.userAgent:"",e=typeof window<"u"&&typeof window.cordova<"u";this.systemParams.os=this.detectOS(t),this.systemParams.isCordova=e}detectOS(t){return/android/i.test(t)?"android":/iPad|iPhone|iPod/i.test(t)?"ios":/Win/i.test(t)?"windows":/Mac/i.test(t)?"macos":/Linux/i.test(t)?"linux":"unknown"}async ensureDeviceId(){const t=this.getStoredDeviceId();if(t)return t;const e=await this.tryGetCordovaDeviceId();if(e)return this.storeDeviceId(e),e;const i=this.generateGuid();return this.storeDeviceId(i),i}getStoredDeviceId(){try{return localStorage.getItem("coreSDK_deviceId")}catch(t){return console.error("[SDK] getStoredDeviceId error:",t),null}}storeDeviceId(t){try{localStorage.setItem("coreSDK_deviceId",t)}catch(e){console.error("[SDK] storeDeviceId error:",e)}}getStoredToken(){try{return localStorage.getItem("coreSDK_token")}catch(t){return console.error("[SDK] getStoredToken error:",t),null}}storeToken(t){try{localStorage.setItem("coreSDK_token",t)}catch(e){console.error("[SDK] storeToken error:",e)}}setUser(t){this.systemParams.user=t}async login(t){try{console.log("[SDK] login: start",{email:t.email});const e=await this.auth.login(t);console.log("[SDK] login: server response received");const i=e?.accessToken??null;if(!i)throw console.error("[SDK] login: ERROR missing token",e),new Error("Login failed: missing token");return this.storeToken(i),this.systemParams.authToken=i,e.user&&this.setUser(e.user),e}catch(e){throw console.error("[SDK] login: ERROR",e),this.captureError(e),e}}async register(t){try{console.log("[SDK] register: start",{email:t.email,username:t.username});const e=await this.auth.register(t);if(console.log("[SDK] register: server response received"),!e)throw console.error("[SDK] register: ERROR missing user data"),new Error("Registration failed: missing user data");return e}catch(e){throw console.error("[SDK] register: ERROR",e),this.captureError(e),e}}async logout(){try{console.log("[SDK] logout: start");try{await this.auth.logout()}catch(t){console.warn("[SDK] logout endpoint error (ignored):",t)}this.clearToken(),this.systemParams.authToken=void 0,this.systemParams.user=null,console.log("[SDK] logout: COMPLETE")}catch(t){throw console.error("[SDK] logout: ERROR",t),this.captureError(t),t}}clearToken(){try{localStorage.removeItem("coreSDK_token")}catch(t){console.error("[SDK] clearToken error:",t)}}async tryGetCordovaDeviceId(){if(typeof window>"u")return null;const t=window;return t.device?.uuid?String(t.device.uuid):null}generateGuid(){const t=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return`${t()}${t()}-${t()}-${t()}-${t()}-${t()}${t()}${t()}`}get profile(){return this.profileClient}}const Jt=s=>Object.freeze({init:s.init.bind(s),configs:{init:s.configs.init.bind(s.configs),fetch:s.configs.fetch.bind(s.configs)},kv:{list:()=>s.kv.list()}}),Vt=m.getInstance(),at=Jt(Vt);typeof window<"u"&&(window.coreSDK=at),o.AbTestsApiClient=Q,o.ApiClient=M,o.AuthApiClient=it,o.ConfigsApiClient=X,o.CoreSDK=m,o.EventBus=B,o.HealthApiClient=st,o.KVApiClient=rt,o.RemoteConfigsApiClient=Z,o.SDK_EVENTS=Ft,o.SDK_VERSION=C,o.SUPPORTED_VERSIONS=w,o.SegmentsApiClient=tt,o.UsersApiClient=et,o.coreSDK=at,o.isVersionSupported=nt,o.sdkConfig=g,o.setAuthUrl=U,o.setBaseUrl=L,o.validateVersion=ot,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
